'use @oigroup/lightscript with noEnforcedSubscriptIndentation'
import { save, findById, destroy, find } from '@ormojo/ormojo'
import { toPlainObject, entity, field, types, listOf, extendField } from '@ormojo/ephraim'
import es_client from '../es_client'
import { ESBackend, ESParentChildRelationship } from '../..'

let backend
let rel

@entity({
  // Elasticsearch backend type info
  index: `widget_parentchild`
  type: `widget`
}) class Widget:
  @field(types.string) id
  @field(types.string) name = 'nameless'
  @field(types.integer) qty = 2
  @field(listOf(types.string)) tags = []

@entity({
  index: `widget_parentchild`
  type: `kidget`
}) class Kidget {
  @field(types.string) id
  @field(types.string) value
}

beforeAll! ->
  logger = console.log.bind(console)
  now backend = new ESBackend(es_client, {
    log: {
      trace: logger
    }
  })

  backend.bind(Widget)
  backend.bind(Kidget)

  now rel = new ESParentChildRelationship(backend).relate(Widget, Kidget)

  mig = backend.createMigration()
  mig.prepare().then(-> mig.execute())

afterAll! ->
  es_client.indices.delete({
    index: [`widget_parentchild*`]
    ignore: [404]
  })

describe('parent-child tests: ', ->
  it('should make a widget and a kidget', ->
    let parent = null
    backend.create(Widget, { value: 'mom'})
    .then((widg) ->
      now parent = widg
      rel.createChild(widg, { value: 'kid' })
    ).then((kidg) ->
      expect(kidg.value).toBe('kid')
      rel.findChildById(parent, kidg.id)
    ).then((kidg) ->
      expect(rel.isChildOf(kidg, parent))
      expect(kidg.value).toBe('kid')
      kidg.value = 'child'
      kidg~save()
    ).then! (kidg) ->
      expect(kidg.value).toBe('child')
      console.log(kidg)
      kidg~destroy()
    .then! (rst) ->
      expect(rst).toBeTruthy()
      kidg = rel.createChild(parent)
      kidg.id = '12345'
      kidg.value = 'kid cudi'
      kidg~save()
    .then! (kidg) ->
      expect(kidg.id).toBe('12345')
      expect(kidg.value).toBe('kid cudi')
      rel.destroyChildById(parent, kidg.id)
    .then! (rst) ->
      expect(rst).toBeTruthy()
      rel.findChildById(parent, '12345')
    .then! (rst) ->
      expect(rst).toBe(undefined)
  )
)
