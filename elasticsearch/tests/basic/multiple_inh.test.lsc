'use @oigroup/lightscript with noEnforcedSubscriptIndentation'
import { entity, field, types, isa, Entity } from '@ormojo/ephraim'
import es_client from '../es_client'
import { ESBackend } from '../..'

let backend

@entity({name: 'Sentient'}) class Sentient extends Entity {
  @field(types.integer) iq = 50

  speak() -> "protolanguage"
}
@entity({name: "Animal"}) class Animal extends Entity {
  @field(types.string) id
  @field(types.integer) iq = 0

  speak() -> "ruff ruff"
}
@entity({name: "Supergenius"}) class Supergenius extends Entity {
  @field(types.integer) iq = 250

  speak() -> "ds^2 = g_mu_nu dx_mu dx_nu"
}

@entity({name: "Elephant", inherits: [Sentient]}) class Elephant extends Animal {}
@entity({name: "Human", inherits: [Sentient]}) class Human extends Animal {
  @field(types.integer) iq = 100
  @field(types.string) name = "Bob"

  speak() -> "hello friend"
}
@entity({name: "Einstein", inherits: [Supergenius]}) class Einstein extends Human {
  @field(types.string) name = "Albert"
}

@entity({
  name: "ESHuman"
  index: `es_test_mi`
  type: `human`
}) class ESHuman extends Human {}

@entity({
  name: "ESElephant"
  index: `es_test_mi`
  type: `elephant`
}) class ESElephant extends Elephant {}

@entity({
  name: "ESAnimal"
  index: `es_test_mi`
  type: `animal`
}) class ESAnimal extends Animal {}

@entity({
  name: "ESEinstein"
  index: `es_test_mi`
  type: `einstein`
}) class ESEinstein extends Einstein {}

beforeAll! ->
  logger = console.log.bind(console)
  now backend = new ESBackend(es_client, {
    log: {
      trace: logger
    }
  })

  backend.bind(ESHuman)
  backend.bind(ESElephant)
  backend.bind(ESAnimal)
  backend.bind(ESEinstein)

  mig = backend.createMigration()
  debugger
  mig.prepare().then(-> mig.execute())

afterAll! ->
  es_client.indices.delete({
    index: [`es_test_mi*`]
  }, { ignore: 404 })

describe('multiple inheritance tests: ', ->
  it! 'should create, store, and rehydrate multitype objects', ->
    let humanId, elephantId, animalId, einsteinId
    creatures = [ backend.create(ESHuman), backend.create(ESElephant), backend.create(ESAnimal), backend.create(ESEinstein) ]
    backend.save(creatures, { refresh: 'wait_for'})
    .then! (rst) ->
      now [ humanId, elephantId, animalId, einsteinId ] = rst.map(x -> x.id)
      q = backend.createQuery()
      q.setIndexName("es_test_mi")
      q.q("query", "range", "iq", "gte", 0)
      backend.find(q)
    .then! (resultSet) ->
      cmp = {...for elem r in resultSet.getResults():
        {[r.id]: r }
      }
      expect(cmp[elephantId]~isa(Elephant))
      expect(cmp[humanId]~isa(Human))
      expect(cmp[animalId]~isa(Animal))
      expect(cmp[einsteinId]~isa(Einstein))
      expect(cmp[einsteinId]~isa(Human))
      expect(cmp[einsteinId]~isa(Supergenius))
      expect(cmp[einsteinId]~isa(Animal))
)
